{% extends 'base.html' %}

{% block title %}Company Details{% endblock %}

{% block content %}
<h2>Company Details</h2>
<a href="{{ url_for('admin.companies') }}" class="btn btn-secondary mb-3">Back to Companies</a>

<div class="row">
  <div class="col-md-8">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5>{{ company.company_name }}</h5>
        <div>
          {% if user.is_blacklisted %}
            <span class="badge bg-danger">Blacklisted</span>
          {% elif not user.is_approved %}
            <span class="badge bg-warning">Pending Approval</span>
          {% else %}
            <span class="badge bg-success">Approved</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Industry:</strong> {{ company.industry or 'N/A' }}</p>
            <p><strong>Location:</strong> {{ company.location or 'N/A' }}</p>
            <p><strong>Website:</strong> 
              {% if company.website %}
                <a href="{{ company.website }}" target="_blank">{{ company.website }}</a>
              {% else %}
                N/A
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <p><strong>Email:</strong> {{ user.email }}</p>
            <p><strong>Contact Person:</strong> {{ company.contact_person or 'N/A' }}</p>
            <p><strong>Contact Phone:</strong> {{ company.contact_phone or 'N/A' }}</p>
          </div>
        </div>
        <hr>
        <p><strong>Description:</strong></p>
        <p>{{ company.description or 'No description provided.' }}</p>
        <p><strong>Registered:</strong> {{ user.created_at.strftime('%d %b %Y') if user.created_at else 'N/A' }}</p>
      </div>
      <div class="card-footer">
        {% if not user.is_approved %}
        <form action="{{ url_for('admin.approve_company', user_id=user.id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-success">Approve Company</button>
        </form>
        <form action="{{ url_for('admin.reject_company', user_id=user.id) }}" method="POST" style="display:inline;">
          <button type="submit" class="btn btn-danger" onclick="return confirm('Reject and delete this company?')">Reject</button>
        </form>
        {% else %}
        <form action="{{ url_for('admin.blacklist_company', user_id=user.id) }}" method="POST" style="display:inline;">
          {% if user.is_blacklisted %}
          <button type="submit" class="btn btn-success" onclick="return confirm('Remove from blacklist?')">Remove from Blacklist</button>
          {% else %}
          <button type="submit" class="btn btn-danger" onclick="return confirm('Blacklist this company?')">Blacklist Company</button>
          {% endif %}
        </form>
        {% endif %}
      </div>
    </div>
  </div>
  
  <div class="col-md-4">
    <div class="card">
      <div class="card-header">
        <h6>Drive Stats</h6>
      </div>
      <div class="card-body">
        <p><strong>Total Drives:</strong> {{ drives|length }}</p>
        <p><strong>Active:</strong> <span class="badge bg-success">{{ drives|selectattr('is_active')|selectattr('is_approved')|list|length }}</span></p>
        <p><strong>Pending Approval:</strong> <span class="badge bg-warning">{{ drives|rejectattr('is_approved')|list|length }}</span></p>
        <p><strong>Closed:</strong> <span class="badge bg-secondary">{{ drives|rejectattr('is_active')|list|length }}</span></p>
        <p><strong>Total Applications:</strong> {{ total_applications }}</p>
      </div>
    </div>
  </div>
</div>

{% if drives %}
<div class="card mt-3">
  <div class="card-header">
    <h5>Placement Drives</h5>
  </div>
  <div class="card-body">
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Title</th>
          <th>Job Type</th>
          <th>Package</th>
          <th>Deadline</th>
          <th>Status</th>
          <th>Applications</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for drive in drives %}
        <tr>
          <td>{{ drive.title }}</td>
          <td>{{ drive.job_type }}</td>
          <td>{{ drive.package or 'N/A' }}</td>
          <td>{{ drive.application_deadline.strftime('%d %b %Y') if drive.application_deadline else 'N/A' }}</td>
          <td>
            {% if not drive.is_approved %}
              <span class="badge bg-warning">Pending</span>
            {% elif not drive.is_active %}
              <span class="badge bg-secondary">Closed</span>
            {% else %}
              <span class="badge bg-success">Active</span>
            {% endif %}
          </td>
          <td>{{ drive.applications|list|length }}</td>
          <td>
            {% if not drive.is_approved %}
            <form action="{{ url_for('admin.approve_drive', drive_id=drive.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-success btn-sm">Approve</button>
            </form>
            {% elif drive.is_active %}
            <form action="{{ url_for('admin.close_drive', drive_id=drive.id) }}" method="POST" style="display:inline;">
              <button type="submit" class="btn btn-warning btn-sm">Close</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
